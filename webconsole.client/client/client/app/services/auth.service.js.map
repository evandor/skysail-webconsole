{"version":3,"sources":["app/services/auth.service.ts"],"names":[],"mappings":"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","file":"app/services/auth.service.js","sourcesContent":["import {Injectable, EventEmitter} from \"@angular/core\";\r\nimport {WindowService} from './window.service';\r\nimport {Http, Headers} from '@angular/http'\r\n\r\n@Injectable()\r\nexport class AuthService {\r\n    private oAuthCallbackUrl:string;\r\n    private oAuthTokenUrl:string;\r\n    private oAuthUserUrl:string;\r\n    private oAuthUserNameField:string;\r\n    private authenticated:boolean = false;\r\n    private token:string;\r\n    private expires:any = 0;\r\n    private userInfo:any = {};\r\n    private windowHandle:any = null;\r\n    private intervalId:any = null;\r\n    private expiresTimerId:any = null;\r\n    private loopCount = 600;\r\n    private intervalLength = 100;\r\n\r\n    private locationWatcher = new EventEmitter();  // @TODO: switch to RxJS Subject instead of EventEmitter\r\n    private subscription;\r\n\r\n    constructor(private windows:WindowService, private http:Http) {\r\n        http.get('config.json')\r\n            .map(res => res.json())\r\n            .subscribe((config:any) => {\r\n                this.oAuthCallbackUrl = config.callbackUrl;\r\n                this.oAuthTokenUrl = config.implicitGrantUrl;\r\n                this.oAuthTokenUrl = this.oAuthTokenUrl\r\n                    .replace('__callbackUrl__', config.callbackUrl)\r\n                    .replace('__clientId__', config.clientId)\r\n                    .replace('__scopes__', config.scopes);\r\n                this.oAuthUserUrl = config.userInfoUrl;\r\n                this.oAuthUserNameField = config.userInfoNameField;\r\n            })\r\n    }\r\n\r\n    public doLogin() {\r\n        var loopCount = this.loopCount;\r\n        this.windowHandle = this.windows.createWindow(this.oAuthTokenUrl, 'OAuth2 Login');\r\n\r\n        this.intervalId = setInterval(() => {\r\n            if (loopCount-- < 0) {\r\n                clearInterval(this.intervalId);\r\n                this.emitAuthStatus(false);\r\n                this.windowHandle.close();\r\n            } else {\r\n                var href:string;\r\n                try {\r\n                    href = this.windowHandle.location.href;\r\n                } catch (e) {\r\n                    //console.log('Error:', e);\r\n                }\r\n                if (href != null) {\r\n                    var re = /access_token=(.*)/;\r\n                    var found = href.match(re);\r\n                    if (found) {\r\n                        console.log(\"Callback URL:\", href);\r\n                        clearInterval(this.intervalId);\r\n                        var parsed = this.parse(href.substr(this.oAuthCallbackUrl.length + 1));\r\n                        var expiresSeconds = Number(parsed.expires_in) || 1800;\r\n\r\n                        this.token = parsed.access_token;\r\n                        if (this.token) {\r\n                            this.authenticated = true;\r\n                        }\r\n\r\n                        this.startExpiresTimer(expiresSeconds);\r\n                        this.expires = new Date();\r\n                        this.expires = this.expires.setSeconds(this.expires.getSeconds() + expiresSeconds);\r\n\r\n                        this.windowHandle.close();\r\n                        this.emitAuthStatus(true);\r\n                        this.fetchUserInfo();\r\n                    }\r\n                }\r\n            }\r\n        }, this.intervalLength);\r\n    }\r\n\r\n    public doLogout() {\r\n        this.authenticated = false;\r\n        this.expiresTimerId = null;\r\n        this.expires = 0;\r\n        this.token = null;\r\n        this.emitAuthStatus(true);\r\n        console.log('Session has been cleared');\r\n    }\r\n\r\n    private emitAuthStatus(success:boolean) {\r\n        this.locationWatcher.emit({success: success, authenticated: this.authenticated, token: this.token, expires: this.expires});\r\n    }\r\n\r\n    public getSession() {\r\n        return {authenticated: this.authenticated, token: this.token, expires: this.expires};\r\n    }\r\n\r\n    private fetchUserInfo() {\r\n        if (this.token != null) {\r\n            var headers = new Headers();\r\n            headers.append('Authorization', `Bearer ${this.token}`);\r\n            this.http.get(this.oAuthUserUrl, {headers: headers})\r\n                .map(res => res.json())\r\n                .subscribe(info => {\r\n                    this.userInfo = info;\r\n                }, err => {\r\n                    console.error(\"Failed to fetch user info:\", err);\r\n                });\r\n        }\r\n    }\r\n\r\n    public getUserInfo() {\r\n        return this.userInfo;\r\n    }\r\n\r\n    public getUserName() {\r\n        return this.userInfo ? this.userInfo[this.oAuthUserNameField] : null;\r\n    }\r\n\r\n    private startExpiresTimer(seconds:number) {\r\n        if (this.expiresTimerId != null) {\r\n            clearTimeout(this.expiresTimerId);\r\n        }\r\n        this.expiresTimerId = setTimeout(() => {\r\n            console.log('Session has expired');\r\n            this.doLogout();\r\n        }, seconds * 1000); // seconds * 1000\r\n        console.log('Token expiration timer set for', seconds, \"seconds\");\r\n    }\r\n\r\n    public subscribe(onNext:(value:any) => void, onThrow?:(exception:any) => void, onReturn?:() => void) {\r\n        return this.locationWatcher.subscribe(onNext, onThrow, onReturn);\r\n    }\r\n\r\n    public isAuthenticated() {\r\n        return this.authenticated;\r\n    }\r\n\r\n    private parse(str) { // lifted from https://github.com/sindresorhus/query-string\r\n        if (typeof str !== 'string') {\r\n            return {};\r\n        }\r\n\r\n        str = str.trim().replace(/^(\\?|#|&)/, '');\r\n\r\n        if (!str) {\r\n            return {};\r\n        }\r\n\r\n        return str.split('&').reduce(function (ret, param) {\r\n            var parts = param.replace(/\\+/g, ' ').split('=');\r\n            // Firefox (pre 40) decodes `%3D` to `=`\r\n            // https://github.com/sindresorhus/query-string/pull/37\r\n            var key = parts.shift();\r\n            var val = parts.length > 0 ? parts.join('=') : undefined;\r\n\r\n            key = decodeURIComponent(key);\r\n\r\n            // missing `=` should be `null`:\r\n            // http://w3.org/TR/2012/WD-url-20120524/#collect-url-parameters\r\n            val = val === undefined ? null : decodeURIComponent(val);\r\n\r\n            if (!ret.hasOwnProperty(key)) {\r\n                ret[key] = val;\r\n            } else if (Array.isArray(ret[key])) {\r\n                ret[key].push(val);\r\n            } else {\r\n                ret[key] = [ret[key], val];\r\n            }\r\n\r\n            return ret;\r\n        }, {});\r\n    };\r\n\r\n\r\n}\r\n\r\n"],"sourceRoot":"/source/"}