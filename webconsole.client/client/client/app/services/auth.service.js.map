{"version":3,"sources":["app/services/auth.service.ts"],"names":[],"mappings":"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","file":"auth.service.js","sourcesContent":["import {Injectable, EventEmitter} from \"@angular/core\";\nimport {WindowService} from './window.service';\nimport {Http, Headers} from '@angular/http'\n\n@Injectable()\nexport class AuthService {\n    private oAuthCallbackUrl:string;\n    private oAuthTokenUrl:string;\n    private oAuthUserUrl:string;\n    private oAuthUserNameField:string;\n    private authenticated:boolean = false;\n    private token:string;\n    private expires:any = 0;\n    private userInfo:any = {};\n    private windowHandle:any = null;\n    private intervalId:any = null;\n    private expiresTimerId:any = null;\n    private loopCount = 600;\n    private intervalLength = 100;\n\n    private locationWatcher = new EventEmitter();  // @TODO: switch to RxJS Subject instead of EventEmitter\n    private subscription;\n\n    constructor(private windows:WindowService, private http:Http) {\n        http.get('config.json')\n            .map(res => res.json())\n            .subscribe((config:any) => {\n                this.oAuthCallbackUrl = config.callbackUrl;\n                this.oAuthTokenUrl = config.implicitGrantUrl;\n                this.oAuthTokenUrl = this.oAuthTokenUrl\n                    .replace('__callbackUrl__', config.callbackUrl)\n                    .replace('__clientId__', config.clientId)\n                    .replace('__scopes__', config.scopes);\n                this.oAuthUserUrl = config.userInfoUrl;\n                this.oAuthUserNameField = config.userInfoNameField;\n            })\n    }\n\n    public doLogin() {\n        var loopCount = this.loopCount;\n        this.windowHandle = this.windows.createWindow(this.oAuthTokenUrl, 'OAuth2 Login');\n\n        this.intervalId = setInterval(() => {\n            if (loopCount-- < 0) {\n                clearInterval(this.intervalId);\n                this.emitAuthStatus(false);\n                this.windowHandle.close();\n            } else {\n                var href:string;\n                try {\n                    href = this.windowHandle.location.href;\n                } catch (e) {\n                    //console.log('Error:', e);\n                }\n                if (href != null) {\n                    var re = /access_token=(.*)/;\n                    var found = href.match(re);\n                    if (found) {\n                        console.log(\"Callback URL:\", href);\n                        clearInterval(this.intervalId);\n                        var parsed = this.parse(href.substr(this.oAuthCallbackUrl.length + 1));\n                        var expiresSeconds = Number(parsed.expires_in) || 1800;\n\n                        this.token = parsed.access_token;\n                        if (this.token) {\n                            this.authenticated = true;\n                        }\n\n                        this.startExpiresTimer(expiresSeconds);\n                        this.expires = new Date();\n                        this.expires = this.expires.setSeconds(this.expires.getSeconds() + expiresSeconds);\n\n                        this.windowHandle.close();\n                        this.emitAuthStatus(true);\n                        this.fetchUserInfo();\n                    }\n                }\n            }\n        }, this.intervalLength);\n    }\n\n    public doLogout() {\n        this.authenticated = false;\n        this.expiresTimerId = null;\n        this.expires = 0;\n        this.token = null;\n        this.emitAuthStatus(true);\n        console.log('Session has been cleared');\n    }\n\n    private emitAuthStatus(success:boolean) {\n        this.locationWatcher.emit({success: success, authenticated: this.authenticated, token: this.token, expires: this.expires});\n    }\n\n    public getSession() {\n        return {authenticated: this.authenticated, token: this.token, expires: this.expires};\n    }\n\n    private fetchUserInfo() {\n        if (this.token != null) {\n            var headers = new Headers();\n            headers.append('Authorization', `Bearer ${this.token}`);\n            this.http.get(this.oAuthUserUrl, {headers: headers})\n                .map(res => res.json())\n                .subscribe(info => {\n                    this.userInfo = info;\n                }, err => {\n                    console.error(\"Failed to fetch user info:\", err);\n                });\n        }\n    }\n\n    public getUserInfo() {\n        return this.userInfo;\n    }\n\n    public getUserName() {\n        return this.userInfo ? this.userInfo[this.oAuthUserNameField] : null;\n    }\n\n    private startExpiresTimer(seconds:number) {\n        if (this.expiresTimerId != null) {\n            clearTimeout(this.expiresTimerId);\n        }\n        this.expiresTimerId = setTimeout(() => {\n            console.log('Session has expired');\n            this.doLogout();\n        }, seconds * 1000); // seconds * 1000\n        console.log('Token expiration timer set for', seconds, \"seconds\");\n    }\n\n    public subscribe(onNext:(value:any) => void, onThrow?:(exception:any) => void, onReturn?:() => void) {\n        return this.locationWatcher.subscribe(onNext, onThrow, onReturn);\n    }\n\n    public isAuthenticated() {\n        return this.authenticated;\n    }\n\n    private parse(str) { // lifted from https://github.com/sindresorhus/query-string\n        if (typeof str !== 'string') {\n            return {};\n        }\n\n        str = str.trim().replace(/^(\\?|#|&)/, '');\n\n        if (!str) {\n            return {};\n        }\n\n        return str.split('&').reduce(function (ret, param) {\n            var parts = param.replace(/\\+/g, ' ').split('=');\n            // Firefox (pre 40) decodes `%3D` to `=`\n            // https://github.com/sindresorhus/query-string/pull/37\n            var key = parts.shift();\n            var val = parts.length > 0 ? parts.join('=') : undefined;\n\n            key = decodeURIComponent(key);\n\n            // missing `=` should be `null`:\n            // http://w3.org/TR/2012/WD-url-20120524/#collect-url-parameters\n            val = val === undefined ? null : decodeURIComponent(val);\n\n            if (!ret.hasOwnProperty(key)) {\n                ret[key] = val;\n            } else if (Array.isArray(ret[key])) {\n                ret[key].push(val);\n            } else {\n                ret[key] = [ret[key], val];\n            }\n\n            return ret;\n        }, {});\n    };\n\n\n}\n\n"]}